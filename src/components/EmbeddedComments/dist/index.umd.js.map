{"version":3,"file":"index.umd.js","sources":["../lib/util.js","../lib/comments.js","../lib/index.js"],"sourcesContent":["export function _getCommentsElement(element, create) {\n\n  var bo = element.businessObject;\n\n  var docs = bo.get('documentation');\n\n  var comments;\n\n  // get comments node\n  docs.some(function(d) {\n    return d.textFormat === 'text/x-comments' && (comments = d);\n  });\n\n  // create if not existing\n  if (!comments && create) {\n    comments = bo.$model.create('bpmn:Documentation', { textFormat: 'text/x-comments' });\n    docs.push(comments);\n  }\n\n  return comments;\n}\n\nexport function getComments(element) {\n  var doc = _getCommentsElement(element);\n\n  if (!doc || !doc.text) {\n    return [];\n  } else {\n    return doc.text.split(/;\\r?\\n;/).map(function(str) {\n      return str.split(/:/, 2);\n    });\n  }\n}\n\nexport function setComments(element, comments) {\n  var doc = _getCommentsElement(element, true);\n\n  var str = comments.map(function(c) {\n    return c.join(':');\n  }).join(';\\n;');\n\n  doc.text = str;\n}\n\nexport function addComment(element, author, str) {\n  var comments = getComments(element);\n\n  comments.push([ author, str ]);\n\n  setComments(element, comments);\n}\n\nexport function removeComment(element, comment) {\n  var comments = getComments(element);\n\n  var idx = -1;\n\n  comments.some(function(c, i) {\n\n    var matches = c[0] === comment[0] && c[1] === comment[1];\n\n    if (matches) {\n      idx = i;\n    }\n\n    return matches;\n  });\n\n  if (idx !== -1) {\n    comments.splice(idx, 1);\n  }\n\n  setComments(element, comments);\n}","import $ from 'jquery';\n\nimport {\n  getComments,\n  removeComment,\n  addComment\n} from './util';\n\n\nexport default function Comments(eventBus, overlays, bpmnjs) {\n\n  function toggleCollapse(element) {\n\n    var o = overlays.get({ element: element, type: 'comments' })[0];\n\n    var $overlay = o && o.html;\n\n    if ($overlay) {\n\n      var expanded = $overlay.is('.expanded');\n\n      eventBus.fire('comments.toggle', { element: element, active: !expanded });\n\n      if (expanded) {\n        $overlay.removeClass('expanded');\n      } else {\n        $overlay.addClass('expanded');\n        $overlay.find('textarea').focus();\n      }\n    }\n  }\n\n  function createCommentBox(element) {\n\n    var $overlay = $(Comments.OVERLAY_HTML);\n\n    $overlay.find('.toggle').click(function(e) {\n      toggleCollapse(element);\n    });\n\n    var $commentCount = $overlay.find('[data-comment-count]'),\n        $textarea = $overlay.find('textarea'),\n        $comments = $overlay.find('.comments');\n\n\n    function renderComments() {\n\n      // clear innerHTML\n      $comments.html('');\n\n      var comments = getComments(element);\n\n      comments.forEach(function(val) {\n        var $comment = $(Comments.COMMENT_HTML);\n\n        $comment.find('[data-text]').text(val[1]);\n        $comment.find('[data-delete]').click(function(e) {\n\n          e.preventDefault();\n\n          removeComment(element, val);\n          renderComments();\n          $textarea.val(val[1]);\n        });\n\n        $comments.append($comment);\n      });\n\n      $overlay[comments.length ? 'addClass' : 'removeClass']('with-comments');\n\n      $commentCount.text(comments.length ? ('(' + comments.length + ')') : '');\n\n      eventBus.fire('comments.updated', { comments: comments });\n    }\n\n    $textarea.on('keydown', function(e) {\n      if (e.which === 13 && !e.shiftKey) {\n        e.preventDefault();\n\n        var comment = $textarea.val();\n\n        if (comment) {\n          addComment(element, '', comment);\n          $textarea.val('');\n          renderComments();\n        }\n      }\n    });\n\n\n    // attach an overlay to a node\n    overlays.add(element, 'comments', {\n      position: {\n        bottom: 10,\n        right: 10\n      },\n      html: $overlay\n    });\n\n    renderComments();\n  }\n\n  eventBus.on('shape.added', function(event) {\n    var element = event.element;\n\n    if (element.labelTarget ||\n       !element.businessObject.$instanceOf('bpmn:FlowNode')) {\n\n      return;\n    }\n\n    defer(function() {\n      createCommentBox(element);\n    });\n\n  });\n\n  this.collapseAll = function() {\n\n    overlays.get({ type: 'comments' }).forEach(function(c) {\n      var html = c.html;\n      if (html.is('.expanded')) {\n        toggleCollapse(c.element);\n      }\n    });\n\n  };\n}\n\nComments.$inject = [ 'eventBus', 'overlays', 'bpmnjs' ];\n\nComments.OVERLAY_HTML =\n  '<div class=\"comments-overlay\">' +\n    '<div class=\"toggle\">' +\n      '<span class=\"icon-comment\"></span>' +\n      '<span class=\"comment-count\" data-comment-count></span>' +\n    '</div>' +\n    '<div class=\"content\">' +\n      '<div class=\"comments\"></div>' +\n      '<div class=\"edit\">' +\n        '<textarea tabindex=\"1\" placeholder=\"Add a comment\"></textarea>' +\n      '</div>' +\n    '</div>' +\n  '</div>';\n\nComments.COMMENT_HTML =\n  '<div class=\"comment\">' +\n    '<div data-text></div><a href class=\"delete icon-delete\" data-delete></a>' +\n  '</div>';\n\n\n// helpers ///////////////\n\nfunction defer(fn) {\n  setTimeout(fn, 0);\n}\n","import Comments from './comments';\n\nexport default {\n  __init__: [ 'comments' ],\n  'comments': [ 'type', Comments ]\n};"],"names":["_getCommentsElement","element","create","bo","businessObject","docs","get","comments","some","d","textFormat","$model","push","getComments","doc","text","split","map","str","setComments","c","join","addComment","author","removeComment","comment","idx","i","matches","splice","Comments","eventBus","overlays","bpmnjs","toggleCollapse","o","type","$overlay","html","expanded","is","fire","active","removeClass","addClass","find","focus","createCommentBox","$","OVERLAY_HTML","click","e","$commentCount","$textarea","$comments","renderComments","forEach","val","$comment","COMMENT_HTML","preventDefault","append","length","on","which","shiftKey","add","position","bottom","right","event","labelTarget","$instanceOf","defer","collapseAll","$inject","fn","setTimeout","__init__"],"mappings":"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"}