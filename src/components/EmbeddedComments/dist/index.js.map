{"version":3,"file":"index.js","sources":["../lib/util.js","../lib/comments.js","../lib/index.js"],"sourcesContent":["export function _getCommentsElement(element, create) {\n\n  var bo = element.businessObject;\n\n  var docs = bo.get('documentation');\n\n  var comments;\n\n  // get comments node\n  docs.some(function(d) {\n    return d.textFormat === 'text/x-comments' && (comments = d);\n  });\n\n  // create if not existing\n  if (!comments && create) {\n    comments = bo.$model.create('bpmn:Documentation', { textFormat: 'text/x-comments' });\n    docs.push(comments);\n  }\n\n  return comments;\n}\n\nexport function getComments(element) {\n  var doc = _getCommentsElement(element);\n\n  if (!doc || !doc.text) {\n    return [];\n  } else {\n    return doc.text.split(/;\\r?\\n;/).map(function(str) {\n      return str.split(/:/, 2);\n    });\n  }\n}\n\nexport function setComments(element, comments) {\n  var doc = _getCommentsElement(element, true);\n\n  var str = comments.map(function(c) {\n    return c.join(':');\n  }).join(';\\n;');\n\n  doc.text = str;\n}\n\nexport function addComment(element, author, str) {\n  var comments = getComments(element);\n\n  comments.push([ author, str ]);\n\n  setComments(element, comments);\n}\n\nexport function removeComment(element, comment) {\n  var comments = getComments(element);\n\n  var idx = -1;\n\n  comments.some(function(c, i) {\n\n    var matches = c[0] === comment[0] && c[1] === comment[1];\n\n    if (matches) {\n      idx = i;\n    }\n\n    return matches;\n  });\n\n  if (idx !== -1) {\n    comments.splice(idx, 1);\n  }\n\n  setComments(element, comments);\n}","import $ from 'jquery';\n\nimport {\n  getComments,\n  removeComment,\n  addComment\n} from './util';\n\n\nexport default function Comments(eventBus, overlays, bpmnjs) {\n\n  function toggleCollapse(element) {\n\n    var o = overlays.get({ element: element, type: 'comments' })[0];\n\n    var $overlay = o && o.html;\n\n    if ($overlay) {\n\n      var expanded = $overlay.is('.expanded');\n\n      eventBus.fire('comments.toggle', { element: element, active: !expanded });\n\n      if (expanded) {\n        $overlay.removeClass('expanded');\n      } else {\n        $overlay.addClass('expanded');\n        $overlay.find('textarea').focus();\n      }\n    }\n  }\n\n  function createCommentBox(element) {\n\n    var $overlay = $(Comments.OVERLAY_HTML);\n\n    $overlay.find('.toggle').click(function(e) {\n      toggleCollapse(element);\n    });\n\n    var $commentCount = $overlay.find('[data-comment-count]'),\n        $textarea = $overlay.find('textarea'),\n        $comments = $overlay.find('.comments');\n\n\n    function renderComments() {\n\n      // clear innerHTML\n      $comments.html('');\n\n      var comments = getComments(element);\n\n      comments.forEach(function(val) {\n        var $comment = $(Comments.COMMENT_HTML);\n\n        $comment.find('[data-text]').text(val[1]);\n        $comment.find('[data-delete]').click(function(e) {\n\n          e.preventDefault();\n\n          removeComment(element, val);\n          renderComments();\n          $textarea.val(val[1]);\n        });\n\n        $comments.append($comment);\n      });\n\n      $overlay[comments.length ? 'addClass' : 'removeClass']('with-comments');\n\n      $commentCount.text(comments.length ? ('(' + comments.length + ')') : '');\n\n      eventBus.fire('comments.updated', { comments: comments });\n    }\n\n    $textarea.on('keydown', function(e) {\n      if (e.which === 13 && !e.shiftKey) {\n        e.preventDefault();\n\n        var comment = $textarea.val();\n\n        if (comment) {\n          addComment(element, '', comment);\n          $textarea.val('');\n          renderComments();\n        }\n      }\n    });\n\n\n    // attach an overlay to a node\n    overlays.add(element, 'comments', {\n      position: {\n        bottom: 10,\n        right: 10\n      },\n      html: $overlay\n    });\n\n    renderComments();\n  }\n\n  eventBus.on('shape.added', function(event) {\n    var element = event.element;\n\n    if (element.labelTarget ||\n       !element.businessObject.$instanceOf('bpmn:FlowNode')) {\n\n      return;\n    }\n\n    defer(function() {\n      createCommentBox(element);\n    });\n\n  });\n\n  this.collapseAll = function() {\n\n    overlays.get({ type: 'comments' }).forEach(function(c) {\n      var html = c.html;\n      if (html.is('.expanded')) {\n        toggleCollapse(c.element);\n      }\n    });\n\n  };\n}\n\nComments.$inject = [ 'eventBus', 'overlays', 'bpmnjs' ];\n\nComments.OVERLAY_HTML =\n  '<div class=\"comments-overlay\">' +\n    '<div class=\"toggle\">' +\n      '<span class=\"icon-comment\"></span>' +\n      '<span class=\"comment-count\" data-comment-count></span>' +\n    '</div>' +\n    '<div class=\"content\">' +\n      '<div class=\"comments\"></div>' +\n      '<div class=\"edit\">' +\n        '<textarea tabindex=\"1\" placeholder=\"Add a comment\"></textarea>' +\n      '</div>' +\n    '</div>' +\n  '</div>';\n\nComments.COMMENT_HTML =\n  '<div class=\"comment\">' +\n    '<div data-text></div><a href class=\"delete icon-delete\" data-delete></a>' +\n  '</div>';\n\n\n// helpers ///////////////\n\nfunction defer(fn) {\n  setTimeout(fn, 0);\n}\n","import Comments from './comments';\n\nexport default {\n  __init__: [ 'comments' ],\n  'comments': [ 'type', Comments ]\n};"],"names":["_getCommentsElement","element","create","bo","businessObject","docs","get","comments","some","d","textFormat","$model","push","getComments","doc","text","split","map","str","setComments","c","join","addComment","author","removeComment","comment","idx","i","matches","splice","Comments","eventBus","overlays","bpmnjs","toggleCollapse","o","type","$overlay","html","expanded","is","fire","active","removeClass","addClass","find","focus","createCommentBox","$","OVERLAY_HTML","click","e","$commentCount","$textarea","$comments","renderComments","forEach","val","$comment","COMMENT_HTML","preventDefault","append","length","on","which","shiftKey","add","position","bottom","right","event","labelTarget","$instanceOf","defer","collapseAll","$inject","fn","setTimeout","__init__"],"mappings":";;;;AAAO,SAASA,mBAAT,CAA6BC,OAA7B,EAAsCC,MAAtC,EAA8C;MAE/CC,EAAE,GAAGF,OAAO,CAACG,cAAjB;MAEIC,IAAI,GAAGF,EAAE,CAACG,GAAH,CAAO,eAAP,CAAX;MAEIC,QAAJ,CANmD;;EASnDF,IAAI,CAACG,IAAL,CAAU,UAASC,CAAT,EAAY;WACbA,CAAC,CAACC,UAAF,KAAiB,iBAAjB,KAAuCH,QAAQ,GAAGE,CAAlD,CAAP;GADF,EATmD;;MAc/C,CAACF,QAAD,IAAaL,MAAjB,EAAyB;IACvBK,QAAQ,GAAGJ,EAAE,CAACQ,MAAH,CAAUT,MAAV,CAAiB,oBAAjB,EAAuC;MAAEQ,UAAU,EAAE;KAArD,CAAX;IACAL,IAAI,CAACO,IAAL,CAAUL,QAAV;;;SAGKA,QAAP;;AAGF,AAAO,SAASM,WAAT,CAAqBZ,OAArB,EAA8B;MAC/Ba,GAAG,GAAGd,mBAAmB,CAACC,OAAD,CAA7B;;MAEI,CAACa,GAAD,IAAQ,CAACA,GAAG,CAACC,IAAjB,EAAuB;WACd,EAAP;GADF,MAEO;WACED,GAAG,CAACC,IAAJ,CAASC,KAAT,CAAe,SAAf,EAA0BC,GAA1B,CAA8B,UAASC,GAAT,EAAc;aAC1CA,GAAG,CAACF,KAAJ,CAAU,GAAV,EAAe,CAAf,CAAP;KADK,CAAP;;;AAMJ,AAAO,SAASG,WAAT,CAAqBlB,OAArB,EAA8BM,QAA9B,EAAwC;MACzCO,GAAG,GAAGd,mBAAmB,CAACC,OAAD,EAAU,IAAV,CAA7B;;MAEIiB,GAAG,GAAGX,QAAQ,CAACU,GAAT,CAAa,UAASG,CAAT,EAAY;WAC1BA,CAAC,CAACC,IAAF,CAAO,GAAP,CAAP;GADQ,EAEPA,IAFO,CAEF,MAFE,CAAV;EAIAP,GAAG,CAACC,IAAJ,GAAWG,GAAX;;AAGF,AAAO,SAASI,UAAT,CAAoBrB,OAApB,EAA6BsB,MAA7B,EAAqCL,GAArC,EAA0C;MAC3CX,QAAQ,GAAGM,WAAW,CAACZ,OAAD,CAA1B;EAEAM,QAAQ,CAACK,IAAT,CAAc,CAAEW,MAAF,EAAUL,GAAV,CAAd;EAEAC,WAAW,CAAClB,OAAD,EAAUM,QAAV,CAAX;;AAGF,AAAO,SAASiB,aAAT,CAAuBvB,OAAvB,EAAgCwB,OAAhC,EAAyC;MAC1ClB,QAAQ,GAAGM,WAAW,CAACZ,OAAD,CAA1B;MAEIyB,GAAG,GAAG,CAAC,CAAX;EAEAnB,QAAQ,CAACC,IAAT,CAAc,UAASY,CAAT,EAAYO,CAAZ,EAAe;QAEvBC,OAAO,GAAGR,CAAC,CAAC,CAAD,CAAD,KAASK,OAAO,CAAC,CAAD,CAAhB,IAAuBL,CAAC,CAAC,CAAD,CAAD,KAASK,OAAO,CAAC,CAAD,CAArD;;QAEIG,OAAJ,EAAa;MACXF,GAAG,GAAGC,CAAN;;;WAGKC,OAAP;GARF;;MAWIF,GAAG,KAAK,CAAC,CAAb,EAAgB;IACdnB,QAAQ,CAACsB,MAAT,CAAgBH,GAAhB,EAAqB,CAArB;;;EAGFP,WAAW,CAAClB,OAAD,EAAUM,QAAV,CAAX;;;AC/Da,SAASuB,QAAT,CAAkBC,QAAlB,EAA4BC,QAA5B,EAAsCC,MAAtC,EAA8C;WAElDC,cAAT,CAAwBjC,OAAxB,EAAiC;QAE3BkC,CAAC,GAAGH,QAAQ,CAAC1B,GAAT,CAAa;MAAEL,OAAO,EAAEA,OAAX;MAAoBmC,IAAI,EAAE;KAAvC,EAAqD,CAArD,CAAR;QAEIC,QAAQ,GAAGF,CAAC,IAAIA,CAAC,CAACG,IAAtB;;QAEID,QAAJ,EAAc;UAERE,QAAQ,GAAGF,QAAQ,CAACG,EAAT,CAAY,WAAZ,CAAf;MAEAT,QAAQ,CAACU,IAAT,CAAc,iBAAd,EAAiC;QAAExC,OAAO,EAAEA,OAAX;QAAoByC,MAAM,EAAE,CAACH;OAA9D;;UAEIA,QAAJ,EAAc;QACZF,QAAQ,CAACM,WAAT,CAAqB,UAArB;OADF,MAEO;QACLN,QAAQ,CAACO,QAAT,CAAkB,UAAlB;QACAP,QAAQ,CAACQ,IAAT,CAAc,UAAd,EAA0BC,KAA1B;;;;;WAKGC,gBAAT,CAA0B9C,OAA1B,EAAmC;QAE7BoC,QAAQ,GAAGW,CAAC,CAAClB,QAAQ,CAACmB,YAAV,CAAhB;IAEAZ,QAAQ,CAACQ,IAAT,CAAc,SAAd,EAAyBK,KAAzB,CAA+B,UAASC,CAAT,EAAY;MACzCjB,cAAc,CAACjC,OAAD,CAAd;KADF;QAIImD,aAAa,GAAGf,QAAQ,CAACQ,IAAT,CAAc,sBAAd,CAApB;QACIQ,SAAS,GAAGhB,QAAQ,CAACQ,IAAT,CAAc,UAAd,CADhB;QAEIS,SAAS,GAAGjB,QAAQ,CAACQ,IAAT,CAAc,WAAd,CAFhB;;aAKSU,cAAT,GAA0B;;MAGxBD,SAAS,CAAChB,IAAV,CAAe,EAAf;UAEI/B,QAAQ,GAAGM,WAAW,CAACZ,OAAD,CAA1B;MAEAM,QAAQ,CAACiD,OAAT,CAAiB,UAASC,GAAT,EAAc;YACzBC,QAAQ,GAAGV,CAAC,CAAClB,QAAQ,CAAC6B,YAAV,CAAhB;QAEAD,QAAQ,CAACb,IAAT,CAAc,aAAd,EAA6B9B,IAA7B,CAAkC0C,GAAG,CAAC,CAAD,CAArC;QACAC,QAAQ,CAACb,IAAT,CAAc,eAAd,EAA+BK,KAA/B,CAAqC,UAASC,CAAT,EAAY;UAE/CA,CAAC,CAACS,cAAF;UAEApC,aAAa,CAACvB,OAAD,EAAUwD,GAAV,CAAb;UACAF,cAAc;UACdF,SAAS,CAACI,GAAV,CAAcA,GAAG,CAAC,CAAD,CAAjB;SANF;QASAH,SAAS,CAACO,MAAV,CAAiBH,QAAjB;OAbF;MAgBArB,QAAQ,CAAC9B,QAAQ,CAACuD,MAAT,GAAkB,UAAlB,GAA+B,aAAhC,CAAR,CAAuD,eAAvD;MAEAV,aAAa,CAACrC,IAAd,CAAmBR,QAAQ,CAACuD,MAAT,GAAmB,MAAMvD,QAAQ,CAACuD,MAAf,GAAwB,GAA3C,GAAkD,EAArE;MAEA/B,QAAQ,CAACU,IAAT,CAAc,kBAAd,EAAkC;QAAElC,QAAQ,EAAEA;OAA9C;;;IAGF8C,SAAS,CAACU,EAAV,CAAa,SAAb,EAAwB,UAASZ,CAAT,EAAY;UAC9BA,CAAC,CAACa,KAAF,KAAY,EAAZ,IAAkB,CAACb,CAAC,CAACc,QAAzB,EAAmC;QACjCd,CAAC,CAACS,cAAF;YAEInC,OAAO,GAAG4B,SAAS,CAACI,GAAV,EAAd;;YAEIhC,OAAJ,EAAa;UACXH,UAAU,CAACrB,OAAD,EAAU,EAAV,EAAcwB,OAAd,CAAV;UACA4B,SAAS,CAACI,GAAV,CAAc,EAAd;UACAF,cAAc;;;KATpB,EA3CiC;;IA2DjCvB,QAAQ,CAACkC,GAAT,CAAajE,OAAb,EAAsB,UAAtB,EAAkC;MAChCkE,QAAQ,EAAE;QACRC,MAAM,EAAE,EADA;QAERC,KAAK,EAAE;OAHuB;MAKhC/B,IAAI,EAAED;KALR;IAQAkB,cAAc;;;EAGhBxB,QAAQ,CAACgC,EAAT,CAAY,aAAZ,EAA2B,UAASO,KAAT,EAAgB;QACrCrE,OAAO,GAAGqE,KAAK,CAACrE,OAApB;;QAEIA,OAAO,CAACsE,WAAR,IACD,CAACtE,OAAO,CAACG,cAAR,CAAuBoE,WAAvB,CAAmC,eAAnC,CADJ,EACyD;;;;IAKzDC,KAAK,CAAC,YAAW;MACf1B,gBAAgB,CAAC9C,OAAD,CAAhB;KADG,CAAL;GATF;;OAeKyE,WAAL,GAAmB,YAAW;IAE5B1C,QAAQ,CAAC1B,GAAT,CAAa;MAAE8B,IAAI,EAAE;KAArB,EAAmCoB,OAAnC,CAA2C,UAASpC,CAAT,EAAY;UACjDkB,IAAI,GAAGlB,CAAC,CAACkB,IAAb;;UACIA,IAAI,CAACE,EAAL,CAAQ,WAAR,CAAJ,EAA0B;QACxBN,cAAc,CAACd,CAAC,CAACnB,OAAH,CAAd;;KAHJ;GAFF;;AAYF6B,QAAQ,CAAC6C,OAAT,GAAmB,CAAE,UAAF,EAAc,UAAd,EAA0B,QAA1B,CAAnB;AAEA7C,QAAQ,CAACmB,YAAT,GACE,mCACE,sBADF,GAEI,oCAFJ,GAGI,wDAHJ,GAIE,QAJF,GAKE,uBALF,GAMI,8BANJ,GAOI,oBAPJ,GAQM,gEARN,GASI,QATJ,GAUE,QAVF,GAWA,QAZF;AAcAnB,QAAQ,CAAC6B,YAAT,GACE,0BACE,0EADF,GAEA,QAHF;;AAQA,SAASc,KAAT,CAAeG,EAAf,EAAmB;EACjBC,UAAU,CAACD,EAAD,EAAK,CAAL,CAAV;;;ACxJF,YAAe;EACbE,QAAQ,EAAE,CAAE,UAAF,CADG;cAED,CAAE,MAAF,EAAUhD,QAAV;CAFd;;;;"}